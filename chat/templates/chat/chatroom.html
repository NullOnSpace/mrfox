{% extends 'blog/base.html' %}

{% block content %}
<div id="chatroom" data-rid="{{ room.id }}">
  <div id="dialog">
  </div>
  <div id="chat-input">
    <textarea name="chat" id="chat-message-input" cols="30" rows="10"></textarea>
    <input type="submit" id="chat-message-submit">
  </div>
</div>
{% endblock %}

{% block domready %}
  const roomId = document.getElementById('chatroom').dataset.rid;

  const chatSocket = new WebSocket(
     'ws://'
     + window.location.host
     + '/ws/chat/'
     + roomId
     + '/'
  );

  chatSocket.onmessage = function(e) {
     const data = JSON.parse(e.data);
     const domMessage = document.createElement("div");
     const domUser = document.createElement("div");
     const domMsgContent = document.createElement("div");
     domMessage.appendChild(domUser);
     domMessage.appendChild(domMsgContent);
     domUser.dataset.uid = data.sender_id;
     domUser.innerText = data.sender_name;
     domMsgContent.innerText = data.message;
     document.querySelector('#dialog').appendChild(domMessage);
  };

  chatSocket.onclose = function(e) {
     console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
     if (e.keyCode === 13) {  // enter, return
         document.querySelector('#chat-message-submit').click();
     }
  };

  document.querySelector('#chat-message-submit').onclick = function(e) {
     const messageInputDom = document.querySelector('#chat-message-input');
     const message = messageInputDom.value;
     chatSocket.send(JSON.stringify({
         'message': message
     }));
     messageInputDom.value = '';
  };
{% endblock %}
